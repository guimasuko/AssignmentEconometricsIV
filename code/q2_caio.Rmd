title: "Trabalho - Econometria IV"
author: "Guilherme Luz, Guilherme Masuko, Caio Garzeri"
date: "`r format(Sys.time(), '%B %Y')`"
output: 
  pdf_document: 
  keep_tex: true
geometry: margin=1in
#bibliography: references.bib 
---
  
  ```{r setup, include=FALSE}
knitr::opts_chunk$set(cache = T, echo = T, tidy = TRUE, tidy.opts = list(width.cutoff = 60), warning = F, message = F)
```

```{r library, include=FALSE}
library(tidyverse)
library(ggplot2)
library(stargazer)
library(kableExtra)
library(gridExtra)
```

```{r}
library(BVAR)
library(lubridate)
library(glmnet)
```


```{r plot_setup, include=FALSE}
# Configurações 
theme_set(theme_linedraw())
theme_update(title = element_text(family = 'serif'),
             legend.text = element_text(family = 'serif')) 
```

# Questão 2

```{r}
raw_data = read.csv("C:/Users/Caio Garzeri/OneDrive - puc-rio.br/Econometria IV/2021-12.csv")
data0 = raw_data[-1,] %>% select_if(~ !any(is.na(.)))
transformation = raw_data[1,]
```

Transformation codes

1. no transformation
2. $\Delta x_t$
3. $\Delta^2 x_t$ 
4. $\log(x_t)$
5. $\Delta \log(x_t)$
6. $\Delta^2 \log(x_t)$
7. $\Delta (x_t/x_{t-1} -1)$
  
```{r}
# Correct names for the automatic transformation to work
data0 <- data0 %>% rename(SP500 = S.P.500)
data0 <- data0 %>% rename(SPINDUST = S.P..indust)

# data transformations based on the FRED transformation codes 
data = data0 %>% select(-sasdate) %>% fred_transform(type = 'fred_md') %>%
  bind_cols(tibble(date = data0$sasdate[3:length(data0$sasdate)])) 

# we lose the first two months of data with transf. First obs of data is mar1959

# for the CPI, we transform into a inflation series
data = mutate(data, CPIAUCSL = 100*(diff(data0$CPIAUCSL, differences = 1)/data0$CPIAUCSL[-1])[-1])

```
\textcolor{blue}{Detalhe: estou usando a definição de inflação dada no enunciado $\pi_t = \frac{\Delta P_t}{P_t}$, que difere da definição usual $\pi_t = \frac{\Delta P_t}{P_{t-1}}$}

```{r}
# plot inflation
inflation = data$CPIAUCSL

data %>% 
  select(date, CPIAUCSL) %>%
  mutate(date = as.Date(date, format = '%m/%d/%Y')) %>%
  #filter(date>as.Date('2000-01-01')) %>%
  ggplot(aes(x = date, y = CPIAUCSL))+
  geom_line()
```
## Item A

### AR

```{r}
# Partial autocorrelation
pacf(inflation, lag.max = 24)
```


```{r}
p.max = 24
bic.table = c()

for(p in 0:p.max){
  AR = arima(inflation, order = c(p,0,0))
  bic.line = tibble("p"=p, "BIC" = BIC(AR))
  bic.table = rbind(bic.table, bic.line)
}

plot(bic.table$p, bic.table$BIC)
```
```{r}
p.opt = bic.table$p[which.min(bic.table$BIC)]
p.opt =12

```

The p chosen with the BIC information criterion was `r p.opt` for the whole series. We'll assume this the right order for all windows.

```{r}
# Create a matrix to store the mean squared errors for different models
MSQ <- data.frame(date = seq(as.Date("2000-01-01"), as.Date("2021-11-01"), by = "month"),
                  ar = numeric(263),
                  factor = numeric(263),
                  ridge = numeric(263),
                  lasso = numeric(263))

# First window stops in Dec 1999 (row 490 of data). Last window stops in October 2011   

for(i in 490:length(data$date)-1) {
  y <- data$CPIAUCSL[1:i]
  pred = predict(arima(y, order = c(p.opt,0,0)), n.ahead=1)
  y_hat = pred$pred
  MSE_AR = (data$CPIAUCSL[i+1] - y_hat)^2
  MSQ$ar[i-491] <- MSE_AR
}

```

### AR + PCR

We start by normalizing all variables. CPI is extracted as the dependent variable

```{r}

data_x <- data %>% select(-c(CPIAUCSL, date))
data_x <- scale(data_x, center=TRUE, scale=TRUE) # center TRUE subtracts mean and scale TRUE divides by s.d.
data_y <- scale(inflation, center=TRUE, scale=TRUE)



```

### Ridge

```{r}
ridge_fit <- ic.glmnet(data_x, data_y, crit="bic", alpha=0)
ridge_lambda_bic <- ridge_fit$lambda

for(i in 490:length(data$date)-1){
  y <- data_y[1:i]
  x <- data_x[1:i,]
  ridge <- glmnet(x,y,alpha=0)
  pred = predict(ridge, newx = data_x[i+1,], s=ridge_lambda_bic)
  MSE_RIDGE = (data_y[i+1] - pred)^2
  MSQ$ridge[i-491] <- MSE_RIDGE
}

```
### LASSO

We will use cv.glmet from HDeconometrics to pick lambda according to the bic. Credits go to 

```{r}

lasso_fit <- ic.glmnet(data_x, data_y, crit="bic", alpha=1)
lambda_bic <- lasso_fit$lambda

for(i in 490:length(data$date)-1){
  y <- data_y[1:i]
  x <- data_x[1:i,]
  lasso <- glmnet(x,y,alpha=1)
  pred = predict(lasso, newx = data_x[i+1,], s=lambda_bic)
  MSE_LASSO = (data_y[i+1] - pred)^2
  MSQ$lasso[i-491] <- MSE_LASSO
}

for(i in 490:length(data$date)-1){
  y <- data_y[1:i]
  x <- data_x[1:i,]
  lasso <- cv.glmnet(x,y,alpha=1, normalize = F)
  pred = predict(lasso, newx = data_x[i+1,], s="lambda.min")
  MSE_LASSO = (data_y[i+1] - pred)^2
  MSQ$lasso[i-491] <- MSE_LASSO
}






```


MSQ <- MSQ %>% mutate(cum_ar = cumsum(ar),
                      cum_ridge = cumsum(ridge),
                      cum_lasso = cumsum(lasso)
                      )

MSQ %>% ggplot(aes(x = date)) +
  geom_line(aes(y = cum_ar, color = "Cumulative AR"), size = 1) +
  geom_line(aes(y = cum_ridge, color = "Cumulative Ridge"), size = 1) +
  geom_line(aes(y = cum_lasso, color = "Cumulative Lasso"), size = 1) +
  labs(x = "Date", y = "Cumulative Sum", title = "Cumulative Sums Over Time") +
  scale_color_manual(values = c("Cumulative AR" = "blue", "Cumulative Ridge" = "red", "Cumulative Lasso" = "green")) +
  theme_minimal()
